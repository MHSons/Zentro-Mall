<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel - ZentroMall</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">

  <div class="max-w-7xl mx-auto">

    <!-- Header -->
    <div class="flex justify-between items-center mb-10">
      <h1 class="text-5xl md:text-6xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-pink-500">
        ZentroMall — Admin Panel
      </h1>

      <div class="flex gap-4">
        <button id="changePassBtn" class="bg-orange-600 hover:bg-orange-700 px-6 py-3 rounded-xl font-bold">Change Password</button>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-xl font-bold">Logout</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-8 mb-8 border-b border-gray-700">
      <button data-tab="products" class="tab-btn pb-4 text-xl md:text-2xl font-semibold border-b-4 border-transparent">Products</button>
      <button data-tab="orders"   class="tab-btn pb-4 text-xl md:text-2xl font-semibold border-b-4 border-transparent">Orders</button>
      <button data-tab="banners"  class="tab-btn pb-4 text-xl md:text-2xl font-semibold border-b-4 border-transparent">Flash Banner</button>
    </div>

    <!-- CONTENT: PRODUCTS -->
    <section id="tab-products" class="tab-content">
      <div class="bg-gray-800 rounded-3xl p-8 md:p-10 shadow-2xl">
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-3xl md:text-4xl font-bold text-green-400">Add New Product</h2>
          <div class="text-gray-400">Total Products: <span id="product-count">0</span></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <input id="pName" placeholder="Product Name" class="p-4 rounded-xl bg-gray-700 text-lg md:text-xl" />
          <input id="pPrice" type="number" placeholder="Price (PKR)" class="p-4 rounded-xl bg-gray-700 text-lg md:text-xl" />
          <input id="pDesc" placeholder="Short Description" class="p-4 rounded-xl bg-gray-700 text-lg md:text-xl" />
          <input type="file" id="pImage" accept="image/*,video/*" class="p-3 rounded-xl bg-gray-700 text-sm md:text-base" />
        </div>

        <div class="flex gap-4">
          <button id="addProductBtn" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 py-4 rounded-xl text-xl md:text-2xl font-bold hover:scale-105 transition">
            ADD PRODUCT
          </button>
          <button id="clearProductsBtn" class="bg-red-600 hover:bg-red-700 px-6 py-4 rounded-xl font-bold">Clear All</button>
        </div>

        <h3 class="text-2xl md:text-3xl font-bold text-cyan-400 mt-10 mb-6">Products</h3>
        <div id="productList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
      </div>
    </section>

    <!-- CONTENT: ORDERS -->
    <section id="tab-orders" class="tab-content hidden mt-8">
      <div class="bg-gray-800 rounded-3xl p-6 md:p-10 shadow-2xl">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-3xl md:text-4xl font-bold text-orange-400">All Orders</h2>
          <div class="flex gap-4 items-center">
            <div class="text-gray-400">Total Orders: <span id="order-count">0</span></div>
            <button id="exportBtn" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-xl font-bold">Export CSV</button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-left table-auto">
            <thead class="bg-gray-700 text-yellow-400">
              <tr>
                <th class="p-3">#</th>
                <th class="p-3">Date</th>
                <th class="p-3">Customer</th>
                <th class="p-3">Phone</th>
                <th class="p-3">Items</th>
                <th class="p-3">Total</th>
                <th class="p-3">Status</th>
                <th class="p-3">Tracking</th>
                <th class="p-3">Action</th>
              </tr>
            </thead>
            <tbody id="orderBody" class="text-sm md:text-base"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CONTENT: BANNERS -->
    <section id="tab-banners" class="tab-content hidden mt-8">
      <div class="bg-gray-800 rounded-3xl p-8 md:p-10 shadow-2xl">
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-3xl md:text-4xl font-bold text-pink-400">Flash Sale Banner</h2>
          <div class="text-gray-400">Total Banners: <span id="banner-count">0</span></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <input id="bannerText" placeholder="Banner Text (optional)" class="p-4 rounded-xl bg-gray-700 text-lg" />
          <input type="file" id="bannerMedia" accept="image/*,video/*" class="p-3 rounded-xl bg-gray-700" />
        </div>

        <div class="flex gap-4">
          <button id="addBannerBtn" class="flex-1 bg-gradient-to-r from-orange-600 to-red-600 py-4 rounded-xl text-xl md:text-2xl font-bold hover:scale-105 transition">ADD BANNER</button>
          <button id="clearBannersBtn" class="bg-red-600 hover:bg-red-700 px-6 py-4 rounded-xl font-bold">Clear All</button>
        </div>

        <h3 class="text-2xl md:text-3xl font-bold text-cyan-400 mt-8 mb-4">Current Banners</h3>
        <div id="bannerList" class="space-y-4"></div>
      </div>
    </section>
  </div>

  <!-- MAIN.SCRIPT (your main.js must be present and loaded first) -->
  <script src="main.js"></script>

  <!-- Admin-specific script -->
  <script>
    // ---------- AUTH / NAV ----------
    function requireLogin() {
      if (localStorage.getItem("zm_admin_logged") !== "true") {
        alert("Login required.");
        location.href = "admin.html";
      }
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("zm_admin_logged");
      location.href = "admin.html";
    });

    document.getElementById("changePassBtn").addEventListener("click", () => {
      const np = prompt("Enter new password (min 4 characters):");
      if (np && np.length >= 4) {
        localStorage.setItem("zm_admin_pass", np);
        alert("Password changed.");
      } else if (np) {
        alert("Password too short.");
      }
    });

    // ---------- TAB HANDLING ----------
    const tabButtons = document.querySelectorAll(".tab-btn");
    function showTab(name) {
      document.querySelectorAll(".tab-content").forEach(s => s.classList.add("hidden"));
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("border-yellow-400"));
      document.getElementById("tab-" + name).classList.remove("hidden");
      document.querySelector(`[data-tab="${name}"]`).classList.add("border-yellow-400");
      // lazy load each tab
      if (name === "products") loadProducts();
      if (name === "orders") loadOrders();
      if (name === "banners") loadBanners();
    }
    tabButtons.forEach(btn => btn.addEventListener("click", e => showTab(btn.dataset.tab)));

    // default open
    document.addEventListener("DOMContentLoaded", () => {
      requireLogin();
      showTab("products");
      updateCounts();
      // ensure cart count and featured rendering on any page load
      if (typeof updateCartCount === "function") updateCartCount();
      if (typeof renderProducts === "function") renderProducts();
    });

    // ---------- HELPERS ----------
    function updateCounts() {
      document.getElementById("product-count").textContent = products.length || 0;
      document.getElementById("order-count").textContent = orders.length || 0;
      document.getElementById("banner-count").textContent = banners.length || 0;
    }

    // ---------- PRODUCTS (Admin) ----------
    const productListEl = document.getElementById("productList");
    function loadProducts() {
      updateCounts();
      if (!products.length) {
        productListEl.innerHTML = `<p class="col-span-4 text-center text-xl text-gray-400 py-16">No products yet</p>`;
        return;
      }
      productListEl.innerHTML = products.map(p => {
        const mediaHTML = p.image && p.image.startsWith("data:video")
          ? `<video src="${p.image}" class="w-full h-48 object-cover" controls loop muted></video>`
          : `<img src="${p.image || 'https://via.placeholder.com/400'}" class="w-full h-48 object-cover" onerror="this.src='https://via.placeholder.com/400/333/fff?text=No+Image'">`;
        return `
          <div class="bg-gray-700 rounded-2xl overflow-hidden shadow-lg flex flex-col">
            ${mediaHTML}
            <div class="p-4 flex-1 flex flex-col">
              <h3 class="font-bold text-lg">${escapeHtml(p.name)}</h3>
              <div class="text-gray-300 text-sm mb-3 flex-1">${escapeHtml(p.desc || "")}</div>
              <div class="flex items-center justify-between gap-4">
                <div class="text-green-400 text-xl font-bold">${formatPrice(p.price)}</div>
                <div class="flex gap-2">
                  <button onclick="editProduct(${p.id})" class="px-3 py-2 bg-yellow-500 rounded-md font-semibold">Edit</button>
                  <button onclick="deleteProduct(${p.id})" class="px-3 py-2 bg-red-600 rounded-md font-semibold">Delete</button>
                </div>
              </div>
            </div>
          </div>`;
      }).join("");
    }

    // add product
    document.getElementById("addProductBtn").addEventListener("click", () => {
      const name = document.getElementById("pName").value.trim();
      const price = Number(document.getElementById("pPrice").value);
      const desc = document.getElementById("pDesc").value.trim();
      const fileInput = document.getElementById("pImage");

      if (!name || !price) return alert("Name and Price required.");

      // if there's a file, use your handleImageUpload (from main.js)
      if (fileInput.files && fileInput.files[0]) {
        handleImageUpload({ target: { files: [fileInput.files[0]] } }, dataUrl => {
          pushNewProduct(name, price, desc, dataUrl);
        });
      } else {
        // default placeholder image
        pushNewProduct(name, price, desc, "https://via.placeholder.com/400");
      }
    });

    function pushNewProduct(name, price, desc, image) {
      const id = products.length ? Math.max(...products.map(x => x.id)) + 1 : 1;
      products.push({ id, name, price, image, desc });
      saveData();
      clearProductForm();
      loadProducts();
      updateCounts();
      alert("Product added.");
    }

    function clearProductForm() {
      document.getElementById("pName").value = "";
      document.getElementById("pPrice").value = "";
      document.getElementById("pDesc").value = "";
      document.getElementById("pImage").value = "";
    }

    function deleteProduct(id) {
      if (!confirm("Delete product permanently?")) return;
      products = products.filter(p => p.id !== id);
      saveData();
      loadProducts();
      updateCounts();
    }

    function editProduct(id) {
      const p = products.find(x => x.id === id);
      if (!p) return alert("Product not found.");
      const newName = prompt("Product name:", p.name);
      if (newName === null) return;
      const newPrice = prompt("Price (PKR):", p.price);
      if (newPrice === null) return;
      const newDesc = prompt("Short description:", p.desc || "");
      p.name = newName.trim() || p.name;
      p.price = Number(newPrice) || p.price;
      p.desc = newDesc === null ? p.desc : newDesc.trim();
      saveData();
      loadProducts();
      alert("Product updated.");
    }

    // Clear all products (danger)
    document.getElementById("clearProductsBtn").addEventListener("click", () => {
      if (!confirm("Clear ALL products? This cannot be undone.")) return;
      products = [];
      saveData();
      loadProducts();
      updateCounts();
    });

    // ---------- ORDERS ----------
    const orderBody = document.getElementById("orderBody");
    function loadOrders() {
      updateCounts();
      if (!orders.length) {
        orderBody.innerHTML = `<tr><td colspan="9" class="p-8 text-center text-gray-400">No orders yet</td></tr>`;
        return;
      }

      orderBody.innerHTML = orders.slice().reverse().map((o, idx) => {
        // show newest first: compute actual index in original array
        const displayIndex = orders.length - idx;
        const realIndex = orders.length - 1 - idx;
        const items = (o.items || []).map(it => `${escapeHtml(it.name)} × ${it.qty}`).join("<br>");
        return `
          <tr class="border-b border-gray-700 hover:bg-gray-800">
            <td class="p-3 font-bold">${displayIndex}</td>
            <td class="p-3">${escapeHtml(o.date)}</td>
            <td class="p-3"><strong>${escapeHtml(o.customer?.name || '')}</strong></td>
            <td class="p-3">${escapeHtml(o.customer?.phone || '')}</td>
            <td class="p-3">${items}</td>
            <td class="p-3 text-green-400 font-bold">${formatPrice(o.total || 0)}</td>
            <td class="p-3">
              <button onclick="toggleStatus(${realIndex})" class="px-3 py-2 rounded-md font-semibold ${o.status === 'complete' ? 'bg-green-600' : 'bg-yellow-600'}">
                ${o.status === 'complete' ? 'Complete' : 'Pending'}
              </button>
            </td>
            <td class="p-3">
              <input type="text" value="${escapeHtml(o.tracking_id||'')}" onchange="saveTracking(${realIndex}, this.value)" class="bg-gray-700 px-2 py-2 rounded w-40 text-sm" />
            </td>
            <td class="p-3">
              <button onclick="deleteOrder(${realIndex})" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded-md font-semibold">Delete</button>
            </td>
          </tr>
        `;
      }).join("");
    }

    function toggleStatus(index) {
      if (!orders[index]) return;
      orders[index].status = orders[index].status === "complete" ? "pending" : "complete";
      saveData();
      loadOrders();
      updateCounts();
    }

    function saveTracking(index, v) {
      if (!orders[index]) return;
      orders[index].tracking_id = String(v).trim();
      saveData();
      loadOrders();
    }

    function deleteOrder(index) {
      if (!confirm("Delete order permanently?")) return;
      orders.splice(index, 1);
      saveData();
      loadOrders();
      updateCounts();
    }

    document.getElementById("exportBtn").addEventListener("click", () => {
      if (!orders.length) return alert("No orders to export.");
      let csv = "\uFEFFNo,Date,Name,Phone,Items,Total,Status,Tracking\n";
      orders.forEach((o, i) => {
        const items = (o.items || []).map(x => `${x.name} x${x.qty}`).join(" | ");
        csv += `${i+1},"${o.date}","${o.customer?.name || ''}","${o.customer?.phone || ''}","${items}","${o.total || 0}","${o.status || ''}","${o.tracking_id || ''}"\n`;
      });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
      a.download = `ZentroMall_Orders_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    });

    // ---------- BANNERS ----------
    const bannerListEl = document.getElementById("bannerList");
    function loadBanners() {
      updateCounts();
      if (!banners.length) {
        bannerListEl.innerHTML = `<p class="text-gray-400 py-8">No banners yet</p>`;
        return;
      }
      bannerListEl.innerHTML = banners.map((b, i) => {
        const mediaHTML = b.media
          ? (b.media.startsWith("data:video")
            ? `<video src="${b.media}" class="w-96 h-48 object-cover rounded-lg" controls muted loop></video>`
            : `<img src="${b.media}" class="w-96 h-48 object-cover rounded-lg" />`)
          : '';
        return `
          <div class="bg-gray-700 rounded-md p-4 flex items-start justify-between gap-4">
            <div>
              <div class="text-lg font-bold">${escapeHtml(b.text || '')}</div>
              <div class="mt-2">${mediaHTML}</div>
            </div>
            <div class="flex flex-col gap-2">
              <button onclick="deleteBanner(${i})" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-md font-semibold">Delete</button>
            </div>
          </div>`;
      }).join("");
    }

    document.getElementById("addBannerBtn").addEventListener("click", () => {
      const text = document.getElementById("bannerText").value.trim();
      const fileInput = document.getElementById("bannerMedia");
      if (!text && (!fileInput.files || !fileInput.files.length)) return alert("Provide banner text or upload media.");

      if (fileInput.files && fileInput.files[0]) {
        handleImageUpload({ target: { files: [fileInput.files[0]] } }, dataUrl => {
          banners.push({ text, media: dataUrl });
          saveData();
          document.getElementById("bannerText").value = "";
          fileInput.value = "";
          loadBanners();
          updateCounts();
          alert("Banner added.");
        });
      } else {
        banners.push({ text, media: "" });
        saveData();
        document.getElementById("bannerText").value = "";
        loadBanners();
        updateCounts();
        alert("Text banner added.");
      }
    });

    function deleteBanner(i) {
      if (!confirm("Delete banner?")) return;
      banners.splice(i, 1);
      saveData();
      loadBanners();
      updateCounts();
    }

    // clear all banners
    document.getElementById("clearBannersBtn").addEventListener("click", () => {
      if (!confirm("Clear ALL banners?")) return;
      banners = [];
      saveData();
      loadBanners();
      updateCounts();
    });

    // ---------- UTIL: sanitize ----------
    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str).replace(/[&<>"'`]/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;'
      }[s]));
    }

    // ---------- Public helper to refresh admin UI if main.js changes external data ----------
    function refreshAdminUI() {
      loadProducts();
      loadOrders();
      loadBanners();
      updateCounts();
      if (typeof updateCartCount === "function") updateCartCount();
    }

    // expose refresh to console for debugging
    window.refreshAdminUI = refreshAdminUI;

  </script>

</body>
</html>
