<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - ZentroMall</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6" onload="checkLogin(); loadOrders(); loadProducts(); loadBanners()">

  <div class="max-w-7xl mx-auto">
    <h1 class="text-5xl font-bold text-center mb-8 text-yellow-400">ADMIN PANEL</h1>

    <!-- Orders History -->
    <div class="bg-gray-800 rounded-2xl p-8 mb-8">
      <h2 class="text-3xl font-bold mb-6">Order History</h2>
      <input type="text" id="searchOrder" placeholder="Search orders..." class="w-full p-4 rounded bg-gray-700 mb-4" onkeyup="searchOrders()">
      <button onclick="exportToExcel()" class="bg-blue-600 px-6 py-3 rounded mb-4">Export to Excel</button>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-700">
            <tr>
              <th>#</th><th>Date</th><th>Name</th><th>Phone</th><th>Items</th><th>Total</th><th>Status</th><th>Tracking ID</th><th>Action</th>
            </tr>
          </thead>
          <tbody id="orderBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Products Management -->
    <div class="bg-gray-800 rounded-2xl p-8 mb-8">
      <h2 class="text-3xl font-bold mb-6">Add/Edit Product</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input id="prodName" placeholder="Product Name" class="p-4 rounded bg-gray-700">
        <input id="prodPrice" type="number" placeholder="Price (PKR)" class="p-4 rounded bg-gray-700">
        <input id="prodDesc" placeholder="Description" class="p-4 rounded bg-gray-700 col-span-2">
        <input type="file" id="prodMedia" accept="image/*,video/*" class="p-4 bg-gray-700 col-span-2">
      </div>
      <button onclick="addOrEditProduct()" class="mt-4 w-full bg-green-600 py-4 rounded font-bold">Save Product</button>
      <div id="productList" class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8"></div>
    </div>

    <!-- Banner Management -->
    <div class="bg-gray-800 rounded-2xl p-8">
      <h2 class="text-3xl font-bold mb-6">Add/Edit Banner</h2>
      <input id="bannerText" placeholder="Banner Text" class="p-4 rounded bg-gray-700 w-full mb-4">
      <input type="file" id="bannerMedia" accept="image/*,video/*" class="p-4 bg-gray-700 w-full mb-4">
      <button onclick="addOrEditBanner()" class="w-full bg-orange-600 py-4 rounded font-bold">Save Banner</button>
      <div id="bannerList" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8"></div>
    </div>
  </div>

  <script src="main.js"></script>
  <script>
    function checkLogin() { if(localStorage.getItem("zm_admin_logged") !== "true") location.href = "admin.html"; }
    function logout() { localStorage.removeItem("zm_admin_logged"); location.href = "admin.html"; }

    function loadOrders() {
      const tbody = document.getElementById("orderBody");
      tbody.innerHTML = orders.slice().reverse().map((o, idx) => {
        const realIdx = orders.length - 1 - idx;
        const items = o.items.map(it => `${it.name} x${it.qty}`).join("<br>");
        return `
          <tr class="border-b border-gray-600">
            <td>${orders.length - idx}</td>
            <td>${o.date}</td>
            <td>${o.customer.name}</td>
            <td>${o.customer.phone}</td>
            <td class="text-left">${items}</td>
            <td>${formatPrice(o.total)}</td>
            <td>
              <select onchange="updateStatus(${realIdx}, this.value)" class="bg-gray-700 rounded p-2">
                <option value="pending" ${o.status==='pending'?'selected':''}>Pending</option>
                <option value="complete" ${o.status==='complete'?'selected':''}>Complete</option>
              </select>
            </td>
            <td>
              <input type="text" value="${o.tracking_id||''}" onchange="updateTracking(${realIdx}, this.value)" class="bg-gray-700 rounded p-2 w-full">
            </td>
            <td>
              <button onclick="deleteOrder(${realIdx})" class="bg-red-600 px-4 py-2 rounded">Delete</button>
            </td>
          </tr>`;
      }).join("") || "<tr><td colspan='9' class='py-10 text-2xl text-gray-500'>No orders</td></tr>";
    }

    function updateStatus(i, s) { orders[i].status = s; saveData(); alert("Status updated!"); }
    function updateTracking(i, t) { orders[i].tracking_id = t; saveData(); alert("Tracking ID saved!"); }
    function deleteOrder(i) { if(confirm("Delete?")) { orders.splice(i,1); saveData(); loadOrders(); } }

    function loadProducts() {
      document.getElementById("productList").innerHTML = products.map(p => `
        <div class="bg-gray-700 p-4 rounded">
          <img src="${p.image}" class="w-full h-32 object-cover mb-2">
          <h3 class="font-bold">${p.name}</h3>
          <p>${formatPrice(p.price)}</p>
          <p class="text-sm">${p.desc}</p>
          <button onclick="editProduct(${p.id})" class="bg-blue-600 px-4 py-2 rounded mt-2">Edit</button>
          <button onclick="deleteProduct(${p.id})" class="bg-red-600 px-4 py-2 rounded mt-2">Delete</button>
        </div>
      `).join("") || "<p>No products</p>";
    }

    function addOrEditProduct() {
      const name = document.getElementById("prodName").value.trim();
      const price = Number(document.getElementById("prodPrice").value);
      const desc = document.getElementById("prodDesc").value.trim();
      const file = document.getElementById("prodMedia").files[0];

      if (!name || !price) return alert("Name and price required!");
      const id = document.getElementById("prodId")?.value || Date.now();

      if(file) {
        handleImageUpload({target: {files: [file]}}, (media) => {
          updateProduct(id, name, price, desc, media);
        });
      } else {
        updateProduct(id, name, price, desc);
      }
    }

    function updateProduct(id, name, price, desc, media) {
      const index = products.findIndex(p => p.id === id);
      if (index > -1) {
        products[index].name = name;
        products[index].price = price;
        products[index].desc = desc;
        if(media) products[index].image = media;
        alert("Product updated!");
      } else {
        products.push({id, name, price, image: media, desc});
        alert("Product added!");
      }
      saveData();
      loadProducts();
      clearProductForm();
    }

    function editProduct(id) {
      const p = products.find(x => x.id === id);
      document.getElementById("prodName").value = p.name;
      document.getElementById("prodPrice").value = p.price;
      document.getElementById("prodDesc").value = p.desc;
      // For image/video, user can re-upload if needed
      document.getElementById("prodId") = id; // Hidden, but use variable if needed
    }

    function deleteProduct(id) { if(confirm("Delete product?")) { products = products.filter(x => x.id !== id); saveData(); loadProducts(); } }

    function clearProductForm() {
      document.getElementById("prodName").value = "";
      document.getElementById("prodPrice").value = "";
      document.getElementById("prodDesc").value = "";
      document.getElementById("prodMedia").value = "";
    }

    function loadBanners() {
      document.getElementById("bannerList").innerHTML = banners.map((t,i) => `
        <div class="bg-gray-700 p-4 rounded flex justify-between">
          <span>${t}</span>
          <button onclick="banners.splice(i,1);localStorage.setItem('zm_banners',JSON.stringify(banners));loadBanners()" class="text-red-400">Delete</button>
        </div>
      `).join("") || "<p class='text-gray-500'>No banner added</p>";
    }
    function addOrEditBanner() {
      const text = document.getElementById("bannerText").value.trim();
      const file = document.getElementById("bannerMedia").files[0];
      if(!text) return alert("Banner text required!");
      if(file) {
        handleImageUpload({target: {files: [file]}}, (media) => {
          banners.push({text, media});
          localStorage.setItem("zm_banners", JSON.stringify(banners));
          loadBanners();
        });
      } else {
        banners.push({text, media: ""});
        localStorage.setItem("zm_banners", JSON.stringify(banners));
        loadBanners();
      }
      document.getElementById("bannerText").value = "";
      document.getElementById("bannerMedia").value = "";
    }
  </script>
</body>
</html>
