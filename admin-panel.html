<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - ZentroMall</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6" onload="checkLogin(); loadOrders()">

  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8 bg-gray-800 rounded-2xl p-6">
      <h1 class="text-5xl font-bold text-yellow-400">ADMIN PANEL</h1>
      <div class="flex gap-4">
        <button onclick="changePassword()" class="bg-orange-600 hover:bg-orange-700 px-6 py-3 rounded-lg">Change Password</button>
        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg text-xl">Logout</button>
      </div>
    </div>

    <!-- Orders Table -->
    <div class="bg-gray-800 rounded-2xl p-8">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-4xl font-bold text-cyan-400">All Orders (${orders.length})</h2>
        <div class="flex gap-4">
          <input type="text" id="searchBox" placeholder="Search by name/phone..." class="p-4 rounded-lg bg-gray-700 text-white" onkeyup="searchOrders()">
          <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 px-8 py-4 rounded-lg font-bold">Export Excel</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-700">
            <tr>
              <th class="py-4">#</th>
              <th>Date & Time</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Address</th>
              <th>Items</th>
              <th>Total</th>
              <th>Status</th>
              <th>Tracking ID</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="ordersBody" class="text-center"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="main.js"></script>
  <script>
    function checkLogin() {
      if (localStorage.getItem("zm_admin_logged") !== "true") {
        alert("Please login first!");
        location.href = "admin.html";
      }
    }

    function logout() {
      if (confirm("Logout?")) {
        localStorage.removeItem("zm_admin_logged");
        location.href = "admin.html";
      }
    }

    function changePassword() {
      const np = prompt("Enter new password (min 4 chars):");
      if (np && np.length >= 4) {
        localStorage.setItem("zm_admin_pass", np);
        alert("Password changed successfully!");
      }
    }

    function loadOrders() {
      const tbody = document.getElementById("ordersBody");
      tbody.innerHTML = "";

      if (orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10" class="py-20 text-3xl text-gray-500">No orders yet</td></tr>`;
        return;
      }

      orders.slice().reverse().forEach((order, i) => {
        const realIndex = orders.length - 1 - i;
        const items = order.items.map(it => `${it.name} × ${it.qty}`).join("<br>");

        tbody.innerHTML += `
          <tr class="border-b border-gray-700 hover:bg-gray-700">
            <td class="font-bold text-xl">${orders.length - i}</td>
            <td class="text-sm">${order.date}</td>
            <td class="font-bold text-green-400">${order.customer.name}</td>
            <td>${order.customer.phone}</td>
            <td class="text-sm max-w-xs">${order.customer.address}</td>
            <td class="text-sm">${items}</td>
            <td class="text-2xl font-bold text-yellow-400">${formatPrice(order.total)}</td>
            
            <!-- Status Button -->
            <td>
              <button onclick="toggleStatus(${realIndex})" 
                      class="px-6 py-3 rounded-lg font-bold text-lg ${order.status === 'complete' ? 'bg-green-600' : 'bg-yellow-600'}">
                ${order.status === 'complete' ? 'Complete' : 'Pending'}
              </button>
            </td>

            <!-- Tracking ID - اب پکا سیو ہوگا -->
            <td>
              <input type="text" value="${order.tracking_id || ''}" 
                     onchange="saveTracking(${realIndex}, this.value)" 
                     placeholder="Enter Tracking ID"
                     class="bg-gray-600 text-white px-4 py-3 rounded-lg w-40 text-center font-bold">
            </td>

            <!-- Delete Button -->
            <td>
              <button onclick="deleteOrder(${realIndex})" 
                      class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-bold">
                Delete
              </button>
            </td>
          </tr>`;
      });
    }

    // Status Toggle + Save
    function toggleStatus(i) {
      orders[i].status = orders[i].status === "complete" ? "pending" : "complete";
      saveData();
      loadOrders();
    }

    // Tracking ID Save (فوراً سیو)
    function saveTracking(i, value) {
      orders[i].tracking_id = value.trim();
      saveData();
      alert("Tracking ID saved successfully!");
    }

    // Delete Order
    function deleteOrder(i) {
      if (confirm("Delete this order permanently?")) {
        orders.splice(i, 1);
        saveData();
        loadOrders();
      }
    }

    // Search
    function searchOrders() {
      const term = document.getElementById("searchBox").value.toLowerCase();
      const rows = document.querySelectorAll("#ordersBody tr");
      rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(term) ? "" : "none";
      });
    }

    // Excel Export
    function exportToExcel() {
      if (orders.length === 0) return alert("No orders to export!");

      let csv = "No,Date,Name,Phone,Address,Items,Total,Status,Tracking_ID\n";
      orders.forEach((o, i) => {
        const items = o.items.map(it => `${it.name} x${it.qty}`).join(" | ");
        csv += `${i+1},"${o.date}","${o.customer.name}","${o.customer.phone}","${o.customer.address.replace(/"/g,'""')}","${items}","${o.total}","${o.status}","${o.tracking_id || ''}"\n`;
      });

      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "ZentroMall_Orders_" + new Date().toISOString().slice(0,10) + ".csv";
      link.click();
    }
  </script>
</body>
</html>
