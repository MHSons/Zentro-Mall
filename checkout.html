<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Checkout — E-Commerce</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="cart_checkout.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="topbar">
    <div class="container">
      <a href="index.html" class="logo">E-Commerce</a>
    </div>
  </header>

  <main class="container page">
    <h1>Checkout</h1>
    <div class="grid-2">
      <div id="checkout-form-area"></div>
      <aside id="checkout-summary" class="summary"></aside>
    </div>
    <div id="order-result"></div>
  </main>

  <script src="main.js"></script>
  <script>
    // Simple checkout: capture address + place order (if cart present)
    (function(){
      const STORE = window.App.StorageService;
      const cart = STORE.get('cart','v1') || [];
      if (!cart.length) {
        document.getElementById('checkout-form-area').innerHTML = '<div class="empty">Cart empty. <a href="products.html">Shop</a></div>';
        return;
      }
      const formHtml = `
        <form id="checkout-form">
          <label>Full name <input name="name" required /></label>
          <label>Phone <input name="phone" required /></label>
          <label>Address <textarea name="address" required></textarea></label>
          <label>City <input name="city" required /></label>
          <label>Postal code <input name="postal" required /></label>
          <div><button class="btn" type="submit">Place order</button></div>
        </form>
      `;
      document.getElementById('checkout-form-area').innerHTML = formHtml;

      function renderSummary(){
        const subtotal = cart.reduce((s,i)=>s+i.price*i.qty, 0);
        const shipping = subtotal > 3000 ? 0 : 150;
        const tax = Math.round(subtotal * 0.13);
        const total = subtotal + shipping + tax;
        document.getElementById('checkout-summary').innerHTML = `
          <div>Items: ${cart.length}</div>
          <div>Subtotal: ${window.App.currency(subtotal)}</div>
          <div>Shipping: ${window.App.currency(shipping)}</div>
          <div>Tax: ${window.App.currency(tax)}</div>
          <div style="font-weight:700;margin-top:8px">Total: ${window.App.currency(total)}</div>
        `;
      }
      renderSummary();

      document.getElementById('checkout-form').addEventListener('submit', (e)=> {
        e.preventDefault();
        const fd = new FormData(e.target);
        const shipping = {
          name: fd.get('name'),
          phone: fd.get('phone'),
          address: fd.get('address'),
          city: fd.get('city'),
          postal: fd.get('postal')
        };
        sessionStorage.setItem('ecom_shipping', JSON.stringify(shipping));
        // simulate payment and create order
        const orders = STORE.get('orders','v1') || [];
        const id = 'o_'+Date.now()+'_'+Math.random().toString(36).slice(2,6);
        const subtotal = cart.reduce((s,i)=>s+i.price*i.qty, 0);
        const shippingCost = subtotal>3000?0:150;
        const tax = Math.round(subtotal * 0.13);
        const total = subtotal + shippingCost + tax;
        const order = {
          id, items: cart, total, status: 'paid', shippingAddress: shipping, createdAt: new Date().toISOString()
        };
        orders.unshift(order);
        STORE.set('orders', orders, 'v1');
        STORE.set('cart', [], 'v1'); // clear cart

        // show invoice
        const result = document.getElementById('order-result');
        result.innerHTML = `<h2>Order placed — ${id}</h2>
          <button id="btn-invoice" class="btn">Download / Print Invoice</button>
          <a href="products.html" class="btn secondary">Back to shopping</a>
        `;
        document.getElementById('btn-invoice').addEventListener('click', ()=> {
          const w = window.open('', '_blank');
          w.document.write(`<html><head><title>Invoice ${id}</title><style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}td,th{border:1px solid #ddd;padding:8px}</style></head><body>`);
          w.document.write(`<h1>Invoice — ${id}</h1>`);
          w.document.write(`<div><strong>Name:</strong> ${shipping.name}<br><strong>Address:</strong> ${shipping.address}, ${shipping.city} (${shipping.postal})</div>`);
          w.document.write(`<table><thead><tr><th>Item</th><th>Qty</th><th>Price</th></tr></thead><tbody>`);
          order.items.forEach(it => {
            w.document.write(`<tr><td>${it.title}</td><td>${it.qty}</td><td>${window.App.currency(it.price * it.qty)}</td></tr>`);
          });
          w.document.write(`</tbody></table><h3>Total: ${window.App.currency(order.total)}</h3>`);
          w.document.write('</body></html>');
          w.document.close();
          w.print();
        });
      });
    })();
  </script>
</body>
</html>
